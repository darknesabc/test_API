/* =========================================================
   ✅ 이동 상세 페이지 (move.html) - 표 + 상단 라인 + 드롭다운
   - Apps Script: move_detail 사용
   - move.html에 아래 ID들이 있어야 함:
     moveUserLine, moveDaysSelect,
     moveDetailLoading, moveDetailError,
     moveDetailTableWrap, moveDetailTbody
========================================================= */
(async function initMoveDetailPage(){
  const userLine = $("moveUserLine");
  const daysSel  = $("moveDaysSelect");
  const loading  = $("moveDetailLoading");
  const error    = $("moveDetailError");
  const wrap     = $("moveDetailTableWrap");
  const tbody    = $("moveDetailTbody");

  // move.html이 아니면 조용히 종료
  if (!loading || !error || !wrap || !tbody || !daysSel) return;

  const session = getSession();
  if (!session) {
    location.href = "index.html";
    return;
  }

  // ✅ 상단 사용자 라인 (취침 상세 스타일)
  if (userLine) {
    const extra = [session.seat, session.teacher ? `${session.teacher} 담임` : null]
      .filter(Boolean).join(" · ");
    userLine.textContent = extra ? `${session.studentName} (${extra})` : session.studentName;
  }

  daysSel.addEventListener("change", () => {
    const days = Number(daysSel.value || 30);
    fetchAndRender(days);
  });

  // 최초 로드
  fetchAndRender(Number(daysSel.value || 30));

  async function fetchAndRender(days) {
    try {
      loading.textContent = "불러오는 중...";
      error.textContent = "";
      wrap.style.display = "none";
      tbody.innerHTML = "";

      const res = await fetch(`${API_BASE}?path=move_detail`, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: session.token, days })
      });

      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "이동 상세 불러오기 실패");

      const items = Array.isArray(data.items) ? data.items : [];
      loading.textContent = "";

      if (!items.length) {
        loading.textContent = "이동 기록이 없습니다.";
        return;
      }

      tbody.innerHTML = items.map(it => {
        const date = String(it.date || "").trim(); // yyyy-MM-dd
        const time = String(it.time || "").trim(); // HH:mm
        const prettyDate = date ? date.slice(5).replace("-", "/") : "";
        const dtPretty = (prettyDate && time) ? `${prettyDate} ${time}` : (it.dt || "-");

        const reason = escapeHtml_(it.reason || "이동");
        const seat   = escapeHtml_(it.seat || "-");
        const score  = escapeHtml_(it.score || "-");

        return `
          <tr>
            <td style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap;">
              ${escapeHtml_(dtPretty)}
            </td>
            <td style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); font-weight:700;">
              ${reason}
            </td>
            <td style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap;">
              ${seat}
            </td>
            <td style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap;">
              ${score}
            </td>
          </tr>
        `;
      }).join("");

      wrap.style.display = "";
    } catch (e) {
      loading.textContent = "";
      error.textContent = e?.message ?? String(e);
    }
  }

  function escapeHtml_(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }
})();
