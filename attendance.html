<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>출결 상세</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body data-needs-login="1">
  <header class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="top-title">출결 상세</div>
        <div id="titleLine" class="top-sub"></div>
      </div>
      <a class="btn btn-ghost" href="dashboard.html">대시보드</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 class="card-title">출결 기록</h2>
      <p id="loading" class="muted">불러오는 중...</p>
      <p id="err" class="msg"></p>

      <div style="overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:12px;">
        <table style="width:max-content; min-width:100%; border-collapse:collapse;">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    function attText(a) {
      const s = String(a ?? "").trim();
      if (s === "1") return "출석";
      if (s === "3") return "결석";
      return s; // 혹시 다른 코드가 나오면 그대로
    }

    function cellText(cell) {
      const sched = String(cell?.s ?? "").trim();
      const att = attText(cell?.a ?? "");
      if (!sched) return att;
      if (!att) return sched;
      return `${sched} · ${att}`;
    }

    (async function () {
      const raw = sessionStorage.getItem("parent_session_v1");
      const session = raw ? JSON.parse(raw) : null;
      if (!session) return;

      const titleLine = document.getElementById("titleLine");
      titleLine.textContent = `${session.studentName} (${session.seat || ""}${session.teacher ? " · " + session.teacher + " 담임" : ""})`;

      const loading = document.getElementById("loading");
      const err = document.getElementById("err");
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");

      try {
        const res = await fetch(`${API_BASE}?path=attendance`, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ token: session.token })
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "불러오기 실패");

        loading.textContent = "";

        const dateHeads = data.dates || [];
        thead.innerHTML = `
          <tr>
            <th style="position:sticky; left:0; background:rgba(10,16,30,0.9); padding:10px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left;">
              교시
            </th>
            ${dateHeads.map(d => `
              <th style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; white-space:nowrap;">
                ${d}
              </th>
            `).join("")}
          </tr>
        `;

        const rows = data.rows || [];
        if (rows.length === 0) {
          tbody.innerHTML = `<tr><td style="padding:10px;">기록이 없습니다.</td></tr>`;
          return;
        }

        tbody.innerHTML = rows.map(r => `
          <tr>
            <td style="position:sticky; left:0; background:rgba(10,16,30,0.85); padding:10px; border-bottom:1px solid rgba(255,255,255,0.06); white-space:nowrap;">
              ${r.period || ""}
            </td>
            ${(r.cells || []).map(cell => `
              <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.06); white-space:nowrap;">
                ${cellText(cell)}
              </td>
            `).join("")}
          </tr>
        `).join("");

      } catch (e) {
        loading.textContent = "";
        err.textContent = e.message || String(e);
      }
    })();
  </script>
</body>
</html>
