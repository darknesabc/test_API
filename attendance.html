<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>출결 상세</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .att-wrap { overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:12px; }
    table.att { border-collapse: collapse; width: max-content; min-width: 100%; }
    table.att th, table.att td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      border-right: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      text-align: left;
      vertical-align: middle;
    }
    table.att th { border-bottom: 1px solid rgba(255,255,255,0.12); }

    /* sticky */
    .sticky-top { position: sticky; top: 0; z-index: 5; background: rgba(10,16,30,0.96); }
    .sticky-left { position: sticky; left: 0; z-index: 6; background: rgba(10,16,30,0.92); }
    .sticky-corner { position: sticky; top:0; left:0; z-index: 7; background: rgba(10,16,30,0.98); }

    /* header styling */
    .day-head { font-weight: 900; letter-spacing: 0.2px; }
    .sub-head { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 2px; }

    /* columns */
    .col-period { min-width: 56px; text-align: center; }
    .col-sched { min-width: 160px; max-width: 220px; overflow: hidden; text-overflow: ellipsis; }
    .col-status { min-width: 84px; text-align: center; font-weight: 900; }

    /* status colors like your sample */
    .status-present { background: rgba(120,255,170,0.18); border-right: 1px solid rgba(120,255,170,0.12); }
    .status-absent  { background: rgba(255,120,120,0.18); border-right: 1px solid rgba(255,120,120,0.12); }
    .status-empty   { color: rgba(255,255,255,0.5); }

    .sched-text { color: rgba(255,255,255,0.90); }
    .sched-muted { color: rgba(255,255,255,0.65); font-size: 12px; }
  </style>
</head>

<body data-needs-login="1">
  <header class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="top-title">출결 상세</div>
        <div id="titleLine" class="top-sub"></div>
      </div>
      <a class="btn btn-ghost" href="dashboard.html">대시보드</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 class="card-title">출결 기록</h2>
      <p id="loading" class="muted">불러오는 중...</p>
      <p id="err" class="msg"></p>

      <div class="att-wrap">
        <table class="att">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px;">
        * 날짜별로 [스케줄 | 출/결] 두 칸으로 표시됩니다.
      </p>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    // 출결코드 -> 텍스트
    function attText(a) {
      const s = String(a ?? "").trim();
      if (s === "1") return "출석";
      if (s === "3") return "결석";
      return "";
    }

    // ✅ "2/2 (Mon)" 같은 라벨을 "2/2" + "월" 로 변환
    function splitDateLabel(label) {
      const s = String(label ?? "").trim();

      const dayMap = {
        Mon: "월", Tue: "화", Wed: "수",
        Thu: "목", Fri: "금", Sat: "토", Sun: "일",
        월: "월", 화: "화", 수: "수", 목: "목",
        금: "금", 토: "토", 일: "일"
      };

      // 예: "2/2 (Mon)" 또는 "2/2 (월)"
      const m = s.match(/^(.+?)\s*\((.+?)\)\s*$/);
      if (m) {
        const date = m[1];
        const rawDay = m[2];
        const day = dayMap[rawDay] || rawDay;
        return { date, day };
      }
      return { date: s, day: "" };
    }

    function statusClass(status) {
      if (status === "출석") return "status-present";
      if (status === "결석") return "status-absent";
      return "status-empty";
    }

    function safeCellObj(cell) {
      // 서버가 {s,a}로 내려주는 경우
      if (cell && typeof cell === "object") {
        return {
          sched: String(cell.s ?? "").trim(),
          code: String(cell.a ?? "").trim()
        };
      }
      // 혹시 문자열로 내려오면(예전 대비)
      const raw = String(cell ?? "").trim();
      if (raw.includes("·")) {
        const parts = raw.split("·").map(x => x.trim());
        const status = parts[1] || "";
        const code = (status === "출석") ? "1" : (status === "결석") ? "3" : "";
        return { sched: parts[0] || "", code };
      }
      if (raw === "출석") return { sched: "", code: "1" };
      if (raw === "결석") return { sched: "", code: "3" };
      return { sched: raw, code: "" };
    }

    (async function () {
      const raw = sessionStorage.getItem("parent_session_v1");
      const session = raw ? JSON.parse(raw) : null;
      if (!session) return;

      document.getElementById("titleLine").textContent =
        `${session.studentName} (${session.seat || ""}${session.teacher ? " · " + session.teacher + " 담임" : ""})`;

      const loading = document.getElementById("loading");
      const err = document.getElementById("err");
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");

      try {
        const res = await fetch(`${API_BASE}?path=attendance`, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ token: session.token })
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "불러오기 실패");

        loading.textContent = "";

        const dates = data.dates || [];
        const rows = data.rows || [];

        // ===== 헤더 (2줄) =====
        // 1줄: 교시 + 날짜(각 날짜가 2칸 colSpan=2)
        // 2줄: (스케줄/출결)
        const topCells = dates.map(d => {
          const { date, day } = splitDateLabel(d);
          return `
            <th class="sticky-top day-head" colspan="2">
              <div>${date}</div>
              <div class="sub-head">${day}</div>
            </th>
          `;
        }).join("");

        const subCells = dates.map(() => `
          <th class="sticky-top sub-head">스케줄</th>
          <th class="sticky-top sub-head">출/결</th>
        `).join("");

        thead.innerHTML = `
          <tr>
            <th class="sticky-corner sticky-top col-period">교시</th>
            ${topCells}
          </tr>
          <tr>
            <th class="sticky-corner sticky-top col-period"></th>
            ${subCells}
          </tr>
        `;

        // ===== 바디 =====
        if (rows.length === 0) {
          tbody.innerHTML = `<tr><td style="padding:10px;">기록이 없습니다.</td></tr>`;
          return;
        }

        tbody.innerHTML = rows.map(r => {
          const cells = (r.cells || []).map(safeCellObj);

          const tds = cells.map(c => {
            const status = attText(c.code);
            const cls = statusClass(status);

            const sched = c.sched;
            const schedHtml = sched
              ? `<div class="sched-text" title="${sched}">${sched}</div>`
              : `<div class="sched-muted"> </div>`;

            const statusHtml = status ? status : "-";

            return `
              <td class="col-sched">${schedHtml}</td>
              <td class="col-status ${cls}">${statusHtml}</td>
            `;
          }).join("");

          return `
            <tr>
              <td class="sticky-left col-period">${r.period || ""}</td>
              ${tds}
            </tr>
          `;
        }).join("");

      } catch (e) {
        loading.textContent = "";
        err.textContent = e.message || String(e);
      }
    })();
  </script>
</body>
</html>
