<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>출결 상세</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .att-wrap { overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:12px; }
    table.att { border-collapse: collapse; width: 100%; table-layout: fixed; }
    table.att.week-wide { width: max-content; min-width: 100%; table-layout: auto; }
    table.att.one-day { width: 100%; table-layout: fixed; }

    table.att th, table.att td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      border-right: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      text-align: left;
      vertical-align: middle;
    }
    table.att th { border-bottom: 1px solid rgba(255,255,255,0.12); }

    .sticky-top { position: sticky; top: 0; z-index: 5; background: rgba(10,16,30,0.96); }
    .sticky-left { position: sticky; left: 0; z-index: 6; background: rgba(10,16,30,0.92); }
    .sticky-corner { position: sticky; top:0; left:0; z-index: 7; background: rgba(10,16,30,0.98); }

    .day-head { font-weight: 900; letter-spacing: 0.2px; text-align:center; }
    .sub-head { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 2px; text-align:center; }

    .col-period { min-width: 56px; text-align: center; }
    .col-sched { min-width: 160px; max-width: 260px; overflow: hidden; text-overflow: ellipsis; }
    .col-status { min-width: 84px; text-align: center; font-weight: 900; }

    .status-present { background: rgba(120,255,170,0.18); border-right: 1px solid rgba(120,255,170,0.12); }
    .status-absent  { background: rgba(255,120,120,0.18); border-right: 1px solid rgba(255,120,120,0.12); }
    .status-empty   { color: rgba(255,255,255,0.5); }

    .sched-text { color: rgba(255,255,255,0.92); }
    .sched-muted { color: rgba(255,255,255,0.55); font-size: 12px; }

    .summary-box{
      margin: 12px 0 14px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
    }
    .summary-title{ font-weight: 900; margin-bottom: 6px; }
    .summary-line{ color: rgba(255,255,255,0.88); font-weight:800; }
    .summary-sub{ margin-top: 6px; color: rgba(255,255,255,0.75); font-size: 13px; }

    /* ✅ 오늘만(1일) 뷰: 2컬럼(스케줄/출결) 비율 */
    table.att.one-day th.col-sched, table.att.one-day td.col-sched { width: 70%; }
    table.att.one-day th.col-status, table.att.one-day td.col-status { width: 30%; }
  
    .col-period{ cursor:help; }
  
    /* ===== 교시 시간(1안): 셀 안에 표시, hover/터치 시에만 노출 ===== */
    .col-period { cursor: default; }
    .period-num { font-weight: 800; }
    .period-time {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity .15s ease, transform .15s ease;
      color: rgba(255,255,255,0.65);
      white-space: nowrap;
    }
    .col-period:hover .period-time { opacity: 1; transform: translateY(0); }
    .col-period.show-time .period-time { opacity: 1; transform: translateY(0); }

  </style>
</head>

<body data-needs-login="1">
  <header class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="top-title">출결 상세</div>
        <!-- ✅ 다른 페이지처럼 학생 정보 표시 -->
        <div id="titleLine" class="top-sub"></div>
      </div>
      <!-- ✅ script.js 간섭 방지: id를 logoutBtn으로 쓰지 않음 -->
      <button id="dashBtn" class="btn btn-ghost" type="button">대시보드</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 class="card-title">출결 기록</h2>
      <p id="loading" class="muted">불러오는 중...</p>
      <p id="err" class="msg"></p>

      <div class="summary-box" id="weeklySummary" style="display:none;">
        <div class="summary-title">이번 주 출결 요약</div>
        <div class="summary-line" id="sumCounts"></div>
        <div class="summary-sub" id="sumRecent"></div>
        <div class="summary-sub" style="opacity:.85;">
          * 결석은 “스케줄 공란 + 결석”만 집계됩니다. (오늘 기준, 미래 제외)
        </div>
      </div>
<button id="toggleViewBtn" class="btn btn-ghost" style="margin:10px 0 14px 0; display:none;">주간 전체 보기</button>

      <div class="att-wrap">
        <table class="att">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px;">
        * 날짜별로 [스케줄 | 출/결] 두 칸으로 표시됩니다.
      </p>

      <div style="display:flex; justify-content:flex-end; margin-top:10px;">
        <button id="logoutBtn2" class="btn btn-ghost" type="button">로그아웃</button>
      </div>
    </section>
  </main>

  <!-- script.js가 API_BASE/SESSION_KEY 등을 제공하는 경우를 위해 유지 -->
  <script src="script.js"></script>
  <script>
    // ====== 안전한 전역 상수 접근 ======
    function getApiBase() {
      if (typeof API_BASE !== "undefined") return API_BASE;
      return "";
    }
    function getSessionKey() {
      if (typeof SESSION_KEY !== "undefined") return SESSION_KEY;
      return "parent_session_v1";
    }

    function showError(msg) {
      const loading = document.getElementById("loading");
      const err = document.getElementById("err");
      if (loading) loading.textContent = "";
      if (err) err.textContent = msg || "오류";
    }

    function attText(a) {
      const s = String(a ?? "").trim();
      if (s === "1") return "출석";
      if (s === "3") return "결석";
      return "";
    }
    function statusClass(status) {
      if (status === "출석") return "status-present";
      if (status === "결석") return "status-absent";
      return "status-empty";
    }

    // ✅ 기본: 오늘만(모든 교시) 표시, 버튼으로 주간 전체 토글
    let SHOW_WEEK_ALL = false; // false=오늘만, true=주간 전체
    window.__ATT_CACHE__ = null; // { data, datesNorm }

    function normalizeDates(datesRaw) {
      const dayMap = {
        Mon: "월", Tue: "화", Wed: "수", Thu: "목", Fri: "금", Sat: "토", Sun: "일",
        월: "월", 화: "화", 수: "수", 목: "목", 금: "금", 토: "토", 일: "일"
      };

      return (datesRaw || []).map(d => {
        if (d && typeof d === "object") {
          const md = String(d.md ?? "").trim();
          const dow = String(d.dow ?? "").trim();
          const iso = String(d.iso ?? "").trim();
          return { md, dow: (dayMap[dow] || dow), iso };
        }
        const s = String(d ?? "").trim();
        const m = s.match(/^(.+?)\s*\((.+?)\)\s*$/);
        if (m) {
          const md = m[1].trim();
          const dow = (dayMap[m[2]] || m[2]);
          return { md, dow, iso: "" };
        }
        return { md: s, dow: "", iso: "" };
      });
    }

    function getTodayIdx(datesNorm, todayIso) {
      if (!datesNorm || !datesNorm.length) return 0;
      const t = String(todayIso || "").trim();
      if (t) {
        const idx = datesNorm.findIndex(d => String(d.iso || "").trim() === t);
        if (idx >= 0) return idx;
      }
      return Math.max(0, datesNorm.length - 1);
    }

    function sliceToTodayView(data, datesNorm) {
      const keep = getTodayIdx(datesNorm, data?.todayIso);
      const dates = [datesNorm[keep]];
      const rows = (data.rows || []).map(r => {
        const cells = (r.cells || []);
        return { ...r, cells: [cells[keep] || {}] };
      });
      return { data: { ...data, rows }, datesNorm: dates };
    }

    function setupToggleButton() {
      const btn = document.getElementById("toggleViewBtn");
      if (!btn) return;

      btn.style.display = "";
      btn.textContent = SHOW_WEEK_ALL ? "오늘만 보기" : "주간 전체 보기";

      // 중복 바인딩 방지
      if (!btn.__bound) {
        btn.__bound = true;
        btn.addEventListener("click", () => {
          SHOW_WEEK_ALL = !SHOW_WEEK_ALL;
          btn.textContent = SHOW_WEEK_ALL ? "오늘만 보기" : "주간 전체 보기";
          const cache = window.__ATT_CACHE__;
          if (cache) renderTable(cache.data, cache.datesNorm);
        if (typeof bindPeriodHintEvents==='function') });
      }
    }

    function renderTable(data, datesNorm) {
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");
      const table = document.querySelector("table.att");

      const view = SHOW_WEEK_ALL ? { data, datesNorm } : sliceToTodayView(data, datesNorm);
      const dNorm = view.datesNorm;
      const rows = view.data.rows || [];


    // ===== 교시 시간 힌트(겹침 방지: 테이블 위에 표시) =====
~ ${it.end}` : "";
    }
box.textContent = `${p}교시  ${t}`;
      box.style.display = "";
    }
, { passive:true });
      });
    }
function getCurrentPeriod(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      // inferStartPeriodByTime는 이미 아래에 있음(입력시간으로 교시 추정)
      const p = inferStartPeriodByTime(`${hh}:${mm}`);
      return p || 0;
    }

      if (table) {
        table.classList.toggle("one-day", dNorm.length === 1);
        table.classList.toggle("week-wide", dNorm.length > 1);
      }

      // ===== 헤더 2행 =====
      const topCells = dNorm.map(d => `
        <th class="sticky-top day-head" colspan="2">
          <div>${d.md || ""}</div>
          <div class="sub-head">${d.dow || ""}</div>
        </th>
      `).join("");

      const subCells = dNorm.map(() => `
        <th class="sticky-top sub-head col-sched">스케줄</th>
        <th class="sticky-top sub-head col-status">출/결</th>
      `).join("");

      thead.innerHTML = `
        <tr>
          <th class="sticky-corner sticky-top col-period">교시</th>
          ${topCells}
        </tr>
        <tr>
          <th class="sticky-corner sticky-top col-period"></th>
          ${subCells}
        </tr>
      `;

      if (!rows.length) {
        tbody.innerHTML = `<tr><td style="padding:10px;">기록이 없습니다.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const tds = (r.cells || []).map(cell => {
          const sched = String(cell?.s ?? "").trim();
          const status = attText(cell?.a);
          const cls = statusClass(status);

          const schedHtml = sched
            ? `<div class="sched-text" title="${sched}">${sched}</div>`
            : `<div class="sched-muted"> </div>`;

          const statusHtml = status ? status : "-";

          return `
            <td class="col-sched">${schedHtml}</td>
            <td class="col-status ${cls}">${statusHtml}</td>
          `;
        }).join("");

      // ✅ 교시 시간(모바일 터치) 바인딩
      bindPeriodInlineTime();

        return `
          <tr>
            <td class="sticky-left col-period" data-period="${r.period || ""}"><div class="period-num">${r.period || ""}</div><div class="period-time">${periodRangeText(r.period || "")}</div></td>
            ${tds}
          </tr>
        `;
      }).join("");

      // ✅ 교시 시간(모바일 터치) 바인딩
      bindPeriodInlineTime();

      // ✅ 교시 시간 힌트 바인딩(렌더 후)
      if (typeof bindPeriodHintEvents==='function') }

    // ===== 요약 =====
    function parseIso(iso) {
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function mondayOf(d) {
      const x = new Date(d);
      const day = x.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }
    function isCountedAbsence(schedule, statusText) {
      if (statusText !== "결석") return false;
      return String(schedule ?? "").trim() === "";
    }

    function buildWeeklySummary(data, datesNorm) {
      const box = document.getElementById("weeklySummary");
      const sumCounts = document.getElementById("sumCounts");
      const sumRecent = document.getElementById("sumRecent");

      const rows = data.rows || [];
      const todayIso = data.todayIso || "";
      if (!datesNorm.length || !rows.length || !todayIso) return;

      const today = parseIso(todayIso);
      today.setHours(0,0,0,0);

      const weekStart = mondayOf(today);
      const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6);

      const weekIdx = [];
      datesNorm.forEach((d, i) => {
        if (!d.iso) return;
        const dd = parseIso(d.iso); dd.setHours(0,0,0,0);
        if (dd >= weekStart && dd <= weekEnd && dd <= today) weekIdx.push(i);
      });
      if (!weekIdx.length) return;

      let present = 0;
      let absent = 0;
      const absEvents = [];

      // ✅ 오늘은 '현재 교시' 이후(미래 교시) 집계 제외
      const curP = getCurrentPeriod();


    // ===== 교시 시간 힌트(겹침 방지: 테이블 위에 표시) =====
~ ${it.end}` : "";
    }
box.textContent = `${p}교시  ${t}`;
      box.style.display = "";
    }
, { passive:true });
      });
    }
function getCurrentPeriod(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      // inferStartPeriodByTime는 이미 아래에 있음(입력시간으로 교시 추정)
      const p = inferStartPeriodByTime(`${hh}:${mm}`);
      return p || 0;
    }

      for (const r of rows) {
        const period = r.period || "";
        const cells = r.cells || [];
        for (const i of weekIdx) {
          const cell = cells[i] || {};
          const sched = String(cell.s ?? "").trim();
          const status = attText(cell.a);

          // ✅ 오늘(같은 날짜)인데 현재 교시 이후면 건너뜀
          if (String(datesNorm[i].iso||"") === String(todayIso) && curP > 0) {
            const pNum = Number(period);
            if (Number.isFinite(pNum) && pNum > curP) continue;
          }

          if (status === "출석") present++;
          if (isCountedAbsence(sched, status)) {
            absent++;
            absEvents.push({ idx: i, period });
          }
        }
      }

      absEvents.sort((a,b) => b.idx - a.idx);
      const top2 = absEvents.slice(0, 2);

      sumCounts.textContent = `출석 ${present}회 · 결석 ${absent}회`;
      if (top2.length === 0) {
        sumRecent.textContent = `최근 결석: 없음`;
      } else {
        const parts = top2.map(x => `${datesNorm[x.idx].md}(${datesNorm[x.idx].dow}) ${x.period}교시`);
        sumRecent.textContent = `최근 결석: ${parts.join(", ")}`;
      }
      box.style.display = "";
    }

    // ===== 이동으로 스케줄 공백 채우기(옵션) =====
    
    function periodRangeText(p){
      const it = PERIODS.find(x => x.p === Number(p));
      return it ? `${it.start} ~ ${it.end}` : "";
    }
    function bindPeriodInlineTime(){
      const tbody = document.getElementById("tbody");
      if (!tbody) return;
      const cells = tbody.querySelectorAll("td.col-period[data-period]");
      cells.forEach(td => {
        if (td.__periodInlineBound) return;
        td.__periodInlineBound = true;
        td.addEventListener("click", () => {
          td.classList.add("show-time");
          clearTimeout(td.__periodInlineTimer);
          td.__periodInlineTimer = setTimeout(() => td.classList.remove("show-time"), 2000);
        }, { passive:true });
      });
    }


    const PERIODS = [
      { p: 1, start: "08:00", end: "08:30" },
      { p: 2, start: "08:50", end: "10:10" },
      { p: 3, start: "10:30", end: "12:00" },
      { p: 4, start: "13:10", end: "14:30" },
      { p: 5, start: "14:50", end: "15:50" },
      { p: 6, start: "16:10", end: "17:30" },
      { p: 7, start: "18:40", end: "20:10" },
      { p: 8, start: "20:30", end: "22:00" },
    ];
    function hhmmToMin(t) {
      const m = String(t ?? "").trim().match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return NaN;
      return Number(m[1]) * 60 + Number(m[2]);
    }
    function inferStartPeriodByTime(timeHHMM) {
      const t = hhmmToMin(timeHHMM);
      if (!Number.isFinite(t)) return 0;
      for (let i = 0; i < PERIODS.length; i++) {
        const cur = PERIODS[i];
        const s = hhmmToMin(cur.start);
        const e = hhmmToMin(cur.end);
        if (t >= s && t <= e) return cur.p;
        const next = PERIODS[i+1];
        if (next) {
          const ns = hhmmToMin(next.start);
          if (t > e && t < ns) return next.p;
        }
      }
      return 0;
    }
    function normalizeMoveDateToIso(dateVal) {
      const s = String(dateVal ?? "").trim();
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
      if (!m) return "";
      return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;
    }
    function buildMoveMap(moveItems) {
      const map = {};
      for (const it of (moveItems || [])) {
        const iso = normalizeMoveDateToIso(it.date);
        const reason = String(it.reason ?? "").trim();
        const rp = Number(it.returnPeriod ?? 0);
        const time = String(it.time ?? "").trim();
        if (!iso || !reason || !rp) continue;

        map[iso] ||= {};
        const sp = inferStartPeriodByTime(time);
        const from = sp > 0 ? sp : Math.max(1, rp - 1);
        const to = rp;
        const start = (from <= to) ? from : Math.max(1, rp - 1);

        for (let p = start; p <= to; p++) map[iso][p] = reason;
      }
      return map;
    }
    function applyMoveToAttendance(attData, datesNorm, moveMap) {
      const rows = attData.rows || [];
      const isoByIdx = (datesNorm || []).map(d => String(d.iso || "").trim());

      for (const r of rows) {
        const periodNum = Number(r.period || 0);
        const cells = r.cells || [];
        for (let i = 0; i < cells.length; i++) {
          const iso = isoByIdx[i];
          if (!iso) continue;
          const c = cells[i] || {};
          const sched = String(c.s ?? "").trim();
          const isEmptySched = (sched === "" || sched === "-");
          if (!isEmptySched) continue;

          const reason = moveMap?.[iso]?.[periodNum];
          if (reason) {
            c.s = reason;
            cells[i] = c;
          }
        }
        r.cells = cells;
      }
      attData.rows = rows;
      return attData;
    }

    async function apiPost(path, bodyObj) {
      const base = getApiBase();
      if (!base) throw new Error("API_BASE 설정을 찾지 못했습니다. script.js의 API_BASE를 확인하세요.");
      const res = await fetch(`${base}?path=${encodeURIComponent(path)}`, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(bodyObj || {})
      });
      const json = await res.json();
      return json;
    }

    // ====== init ======
    (async function init() {
      // 상단 버튼들
      const dashBtn = document.getElementById("dashBtn");
      if (dashBtn) dashBtn.addEventListener("click", () => location.href = "dashboard.html");

      const logout2 = document.getElementById("logoutBtn2");
      if (logout2) logout2.addEventListener("click", () => {
        sessionStorage.removeItem(getSessionKey());
        location.href = "index.html";
      });

      const raw = sessionStorage.getItem(getSessionKey());
      const session = raw ? JSON.parse(raw) : null;
      if (!session || !session.token) {
        showError("세션이 없습니다. 대시보드에서 다시 들어와 주세요.");
        return;
      }

      // ✅ 다른 페이지처럼 학생정보 표시
      const title = document.getElementById("titleLine");
      if (title) {
        const teacherPart = session.teacher ? ` · ${session.teacher} 담임` : "";
        title.textContent = `${session.studentName || ""} (${session.seat || ""}${teacherPart})`;
      }

      try {
        // 1) 출결
        const data = await apiPost("attendance", { token: session.token });
        if (!data || !data.ok) throw new Error(data?.error || "출결 불러오기 실패");

        const datesNorm = normalizeDates(data.dates);

        // 2) 이동(옵션): 스케줄 공란 채우기
        try {
          const moveData = await apiPost("move_detail", { token: session.token, days: 60 });
          if (moveData && moveData.ok) {
            const moveMap = buildMoveMap(moveData.items || []);
            applyMoveToAttendance(data, datesNorm, moveMap);
          }
        } catch (_) {}

        document.getElementById("loading").textContent = "";

        buildWeeklySummary(data, datesNorm);
        window.__ATT_CACHE__ = { data, datesNorm };

        setupToggleButton();
        renderTable(data, datesNorm);

        // ✅ 교시 힌트 이벤트 바인딩
        if (typeof bindPeriodHintEvents==='function') } catch (e) {
        showError(e.message || String(e));
      }
    })();
  </script>
</body>
</html>
